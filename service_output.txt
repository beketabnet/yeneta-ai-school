def get_teacher_enrolled_subjects_with_students(teacher_id):
        """
        Get all unique subjects where teacher has enrolled students with student details
        Returns subjects with student information
        """
        # Note: Not using cache for this endpoint to ensure fresh data
        subject_data = {}
        
        # Get all actual enrollments for teacher's courses
        enrollments = Enrollment.objects.filter(
            course__teacher_id=teacher_id
        ).select_related('student', 'course').order_by('course__title')

        for enrollment in enrollments:
            key = f"{enrollment.course.id}_{enrollment.course.grade_level}"
            
            if key not in subject_data:
                subject_data[key] = {
                    'subject_id': enrollment.course.id,
                    'subject_name': enrollment.course.title,
                    'grade_level': enrollment.course.grade_level,
                    'students': [],
                    'student_ids': set(),
                }
            
            if enrollment.student.id not in subject_data[key]['student_ids']:
                first_name = enrollment.student.first_name or ''
                last_name = enrollment.student.last_name or ''
                full_name = f"{first_name} {last_name}".strip()
                student_name = full_name if full_name else enrollment.student.username
                subject_data[key]['students'].append({
                    'student_id': enrollment.student.id,
                    'student_name': student_name,
                    'username': enrollment.student.username,
                })
                subject_data[key]['student_ids'].add(enrollment.student.id)
        
        # Include approved StudentEnrollmentRequest records
        from .models import StudentEnrollmentRequest
        approved_requests = StudentEnrollmentRequest.objects.filter(
            teacher_id=teacher_id,
            status='approved'
        ).select_related('student')
        
        seen_requests = set()
        
        for req in approved_requests:
            req_unique = (req.student_id, req.subject, req.grade_level)
            
            if req_unique in seen_requests:
                continue
            seen_requests.add(req_unique)
            
            # Check if this matches existing enrollment
            existing_key = None
            for key, data in subject_data.items():
                subject_lower = data['subject_name'].lower()
                req_subject_lower = req.subject.lower()
                
                if ((req_subject_lower in subject_lower or subject_lower in req_subject_lower) and 
                    data['grade_level'] == req.grade_level):
                    existing_key = key
                    break
            
            if existing_key:
                if req.student.id not in subject_data[existing_key]['student_ids']:
                    subject_data[existing_key]['students'].append({
                        'student_id': req.student.id,
                        'student_name': f"{req.student.first_name} {req.student.last_name}".strip() or req.student.username,
                        'username': req.student.username,
                    })
                    subject_data[existing_key]['student_ids'].add(req.student.id)
            else:
                key = f"req_{req.subject}_{req.grade_level}"
                
                if key not in subject_data:
                    subject_data[key] = {
                        'subject_id': None,  # No actual course ID for StudentEnrollmentRequest
                        'subject_name': req.subject,
                        'grade_level': req.grade_level,
                        'students': [],
                        'student_ids': set(),
                    }
                
                if req.student.id not in subject_data[key]['student_ids']:
                    first_name = req.student.first_name or ''
                    last_name = req.student.last_name or ''
                    full_name = f"{first_name} {last_name}".strip()
                    student_name = full_name if full_name else req.student.username
                    subject_data[key]['students'].append({
                        'student_id': req.student.id,
                        'student_name': student_name,
                        'username': req.student.username,
                    })
                    subject_data[key]['student_ids'].add(req.student.id)
        
        result = []
        for key, data in subject_data.items():
            # Remove student_ids set before returning
            student_ids_set = data.pop('student_ids')
            data['student_count'] = len(data['students'])
            
            # Calculate average score for this subject
            student_ids = [s['student_id'] for s in data['students']]
            if student_ids:
                avg_score = StudentGrade.objects.filter(
                    student_id__in=student_ids,
                    subject=data['subject_name'],
                    graded_by_id=teacher_id
                ).aggregate(avg=Avg('score'))['avg']
                data['average_score'] = avg_score
            else:
                data['average_score'] = None
            
            result.append(data)

        result = sorted(result, key=lambda x: (x['subject_name'], x['grade_level']))
        return result
